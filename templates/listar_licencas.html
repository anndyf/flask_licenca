{% extends "base.html" %}
{% with messages = get_flashed_messages(with_categories=True) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% block content %}
<div class="container mt-4">
    <h2>Licenças Cadastradas</h2>
    <table class="table table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>Empresa</th>
                <th>Ato</th>
                <th>Portaria</th>
                <th>Data de Publicação</th>
                <th>Vencimento</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for licenca in licencas %}
            <tr>
                <td>{{ licenca.id }}</td>
                <td>
                    <span class="expand-info" data-bs-toggle="collapse" data-bs-target="#collapse{{ licenca.id }}" aria-expanded="false" style="cursor: pointer;">
                        {{ licenca.empresa }}
                    </span>
                </td>
                <td>{{ licenca.ato }}</td>
                <td>{{ licenca.portaria }}</td>
                <td>{{ licenca.data_publicacao.strftime('%d/%m/%Y') }}</td>
                <td>{{ licenca.vencimento.strftime('%d/%m/%Y') }}</td>
                <td>{{ licenca.status }}</td>
                <td>
                    <a href="{{ url_for('edit_license', id=licenca.id) }}" class="btn btn-warning btn-sm">Editar</a>
                    <button class="btn btn-danger btn-sm delete-btn" data-id="{{ licenca.id }}">Excluir</button>
                </td>
            </tr>
            <tr class="collapse" id="collapse{{ licenca.id }}">
                <td colspan="8">
                    <div class="card card-body">
                        <strong>Empresa:</strong> {{ licenca.empresa }}<br>
                        <strong>Ato:</strong> {{ licenca.ato }}<br>
                        <strong>Portaria:</strong> {{ licenca.portaria }}<br>
                        <strong>Data de Publicação:</strong> {{ licenca.data_publicacao.strftime('%d/%m/%Y') }}<br>
                        <strong>Vencimento:</strong> {{ licenca.vencimento.strftime('%d/%m/%Y') }}<br>
                        <strong>Condicionantes Ambientais:</strong> {{ licenca.condicionantes or 'Nenhuma' }}<br>
                        <strong>Prazo de Cumprimento:</strong> {{ licenca.prazo_cumprimento or 'N/A' }}<br>
                        <strong>Status:</strong> {{ licenca.status }}<br>
                        <strong>Observações:</strong> {{ licenca.observacoes or 'Nenhuma' }}<br>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja excluir esta licença?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Excluir</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript --><script>
    document.addEventListener("DOMContentLoaded", function () {
        let selectedLicenseId = null;

        document.querySelectorAll(".delete-btn").forEach(function (button) {
            button.addEventListener("click", function (event) {
                event.stopPropagation();
                selectedLicenseId = this.getAttribute("data-id");

                let deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                deleteModal.show();
            });
        });

        document.getElementById("confirmDelete").addEventListener("click", function () {
            if (selectedLicenseId) {
                fetch(`/delete_license/${selectedLicenseId}`, {
                    method: "POST"
                }).then(response => {
                    if (response.ok) {
                        let deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                        deleteModal.hide(); // Fecha o modal

                        setTimeout(() => {
                            location.reload(); // Recarrega a página para mostrar a mensagem
                        }, 500);
                    } else {
                        alert("Erro ao excluir a licença.");
                    }
                });
            }
        });
    });
</script>

{% endblock %}
